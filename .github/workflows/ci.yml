name: CI

on:
  pull_request:
    branches: ['main', 'master']
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Backend - Install & Lint
        run: |
          cd backend
          npm ci
          npm run prettier:check --if-present
          npm run lint --if-present

      - name: Frontend - Install & Lint
        run: |
          cd frontend
          npm ci
          npm run prettier:check --if-present
          npm run lint --if-present

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Backend - Install & Test
        run: |
          cd backend
          npm ci
          npm run test

      - name: Frontend - Install & Test
        run: |
          cd frontend
          npm ci
          npm run test

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build with Docker Compose
        run: docker compose build
